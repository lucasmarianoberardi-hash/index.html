<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dietética Virgilio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* --- ESTILOS GENERALES Y LAYOUT --- */

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding-bottom: 80px;
            /* Espacio para la barra de iconos fija */
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .fixed-icons {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #fff;
            border-top: 1px solid #ccc;
            padding: 10px 0;
            z-index: 1000;
        }

        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            font-size: 1.5em;
            color: #555;
            position: relative;
        }

        .icon-button:hover {
            color: #2e8b57;
        }

        .cart-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ff4d4d;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            font-weight: bold;
            display: none;
            /* Se muestra con JS */
            align-items: center;
            justify-content: center;
        }

        #scroll-top-icon {
            background-color: #2e8b57;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            /* Se muestra con JS */
            position: fixed;
            bottom: 85px;
            right: 20px;
            z-index: 999;
        }

        /* --- PANELES FLOTANTES --- */

        #search {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 400px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            z-index: 900;
            display: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #cart {
            position: fixed;
            bottom: 70px;
            right: 10px;
            width: 90%;
            max-width: 450px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 950;
            display: none;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .cart-header img {
            height: 40px;
            width: auto;
        }

        #cart-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
        }

        .cart-item-quantity input {
            width: 40px;
            text-align: center;
            margin: 0 5px;
        }

        .remove-item {
            background: none;
            border: none;
            color: #ff4d4d;
            font-size: 1.2em;
            cursor: pointer;
        }

        #send-order-button {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            background-color: #2e8b57;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #send-order-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .menu-desplegable-contenido {
            position: fixed;
            bottom: 70px;
            left: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 950;
            display: none;
            padding: 10px;
            max-height: 70vh;
            overflow-y: auto;
            width: 90%;
            max-width: 300px;
        }

        .menu-desplegable-contenido ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-desplegable-contenido li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .menu-desplegable-contenido li:last-child {
            border-bottom: none;
        }

        .menu-desplegable-contenido a {
            text-decoration: none;
            color: #333;
            font-size: 1.1em;
            display: block;
            padding: 5px;
            transition: color 0.2s;
        }

        .menu-desplegable-contenido a:hover {
            color: #2e8b57;
        }

        #qr-scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1050;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #qr-scanner-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            position: relative;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        #close-qr-scanner {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
        }

        /* --- SECCIÓN DE PRODUCTOS --- */
        .category {
            margin-top: 30px;
            border-bottom: 2px solid #2e8b57;
            padding-bottom: 15px;
        }

        .category h2 {
            font-size: 1.8em;
            color: #2e8b57;
            text-align: center;
            margin-bottom: 20px;
        }

        .category-products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            justify-items: center;
        }

        .producto {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .producto:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .producto img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .producto-info h3 {
            margin: 0 0 5px;
            font-size: 1.1em;
            color: #333;
        }

        .producto-info p {
            margin: 5px 0;
            font-weight: bold;
            color: #2e8b57;
        }

        .producto-info .no-stock {
            color: #ff4d4d;
            font-size: 0.9em;
        }

        .propiedades-container {
            min-height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .logo-propiedad {
            height: 20px;
            width: auto;
        }

        .descripcion-container {
            margin-top: 5px;
            font-size: 0.8em;
            color: #666;
            line-height: 1.4;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .leer-mas-btn {
            background: none;
            border: none;
            color: #2e8b57;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 5px;
        }

        .producto-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 15px;
        }

        .producto-actions input {
            width: 50px;
            text-align: center;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .add-to-cart-btn {
            background-color: #2e8b57;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
        }

        .add-to-cart-btn:hover {
            background-color: #26734d;
        }

        .add-to-cart-btn:disabled,
        .no-stock-button {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1100;
            animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards;
            white-space: nowrap;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                bottom: 60px;
            }

            to {
                opacity: 1;
                bottom: 80px;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                bottom: 80px;
            }

            to {
                opacity: 0;
                bottom: 60px;
            }
        }

        .scroll-to-top {
            position: fixed;
            bottom: 85px;
            right: 20px;
            background-color: #2e8b57;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.5em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: none;
            z-index: 999;
        }

        /* Estilos para el escáner QR */
        #reader {
            width: 100%;
        }

        #reader__dashboard_section_csr {
            display: none;
        }
    </style>
</head>

<body>
    <div class="fixed-icons">
        <button id="scroll-top-icon" aria-label="Volver al inicio">
            <img src="https://cdn-icons-png.flaticon.com/256/4510/4510643.png" alt="Logo Dietética Virgilio - Volver al Inicio" style="height: 20px; vertical-align: middle;">
        </button>
        <button id="cart-icon" class="icon-button" aria-label="Ver carrito de compras">
            <i class="fas fa-shopping-cart"></i>
            <span id="cart-count" class="cart-count">0</span>
        </button>
        <div class="menu-desplegable">
            <button id="category-icon" class="icon-button" aria-label="Mostrar categorías">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="menu-desplegable-contenido" aria-label="Menú de categorías">
                <ul>
                </ul>
            </nav>
        </div>
        <button id="search-icon" class="icon-button" aria-label="Buscar productos">
            <i class="fas fa-search"></i>
        </button>
        <button id="qr-scan-icon" class="icon-button" aria-label="Escanear código QR">
            <i class="fas fa-qrcode"></i>
        </button>
    </div>

    <input type="text" id="search" placeholder="Buscar producto..." aria-label="Buscar productos" autocomplete="off">

    <div id="qr-scanner-container" style="display: none;">
        <div id="qr-scanner-content">
            <button id="close-qr-scanner" aria-label="Cerrar escáner">&times;</button>
            <h2>Escanear Código QR</h2>
            <div id="reader" style="width: 100%;"></div>
        </div>
    </div>


    <div id="cart" aria-labelledby="cart-icon">
        <div class="cart-header">
            <h2>Mi Carrito</h2>
            <img src="https://media.cylex.com.ar/companies/1128/0419/logo/logo.jpg" alt="Logo Dietética Virgilio">
        </div>
        <div id="cart-items-container">
            <ul id="cart-items"></ul>
        </div>
        <p style="font-size: 1.1em; font-weight: bold; margin-top: 15px;">Subtotal: $<span id="cart-subtotal">0</span></p>
        <p style="font-size: 0.9em; color: green; font-weight: bold;" id="cart-discount-message"></p>
        <p style="font-size: 1.2em; font-weight: bold; margin-top: 5px;">Total final: $<span id="cart-total">0</span></p>
        <button id="send-order-button">Enviar Pedido</button>
    </div>

    <section id="products" class="container">
    </section>

    <button class="scroll-to-top" id="scroll-to-top-footer" aria-label="Volver arriba"><i class="fas fa-arrow-up"></i></button>

    <script>
        // --- Variables y Constantes Globales ---
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let allProducts = [];

        const DISCOUNT_THRESHOLDS = {
            '10%': 10,
            '20%': 20
        };
        const DISCOUNT_PERCENTAGES = {
            '10%': 0.10,
            '20%': 0.20
        };

        const LOGO_URLS = {
            sinTacc: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR5T7nDfaM_05QQOmcKUhuZoU6CnTZt0Ig9bQ&s',
            vegano: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQrWh6bS_uu0DfLFB7tEsj4aojQqHJyzH8brQ&s',
            sinAzucar: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSBK_h6dMpoVwkTRMSr3C3xV46pvgD2BstPhIfEu2WMn9YoxkQM97T456Q_wGZzvZ5j&usqp=CAU',
            sinSal: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTHjYvblrFp9CXaSMblB_l1iDsTcTq9ridCqw&s',
            placeholder: 'https://via.placeholder.com/150?text=Imagen+No+Disp.'
        };

        const productsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTUwKkCP-utyR4uJzAuXrCr2div8FCqsTRN57HMLuY_a0BzuThRPn_ZkfymgPoElcPg5i6UsPEuvGGN/pub?output=csv';

        // --- Funciones de Utilidad ---

        function normalizeText(text) {
            if (typeof text !== 'string') return '';
            return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) {
                console.warn('🟡 CSV vacío o solo con encabezados. No se cargaron productos.');
                return [];
            }
            const headers = lines[0].split(',').map(header => header.trim());
            const products = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length !== headers.length) {
                    console.warn(`🟡 Línea CSV mal formada (se esperaban ${headers.length} valores, se obtuvieron ${values.length}):`, lines[i]);
                    continue;
                }
                const product = {};
                for (let j = 0; j < headers.length; j++) {
                    product[headers[j]] = values[j] ? values[j].trim() : '';
                }
                products.push(product);
            }
            return products;
        }

        function calculateCartTotals() {
            let subtotal = 0;
            let finalTotal = 0;
            let totalDiscountAmount = 0;
            const itemsWithDiscount = [];

            cart.forEach(item => {
                const itemSubtotal = item.price * item.quantity;
                let itemTotal = itemSubtotal;
                let discountPercentage = 0;

                if (item.quantity >= DISCOUNT_THRESHOLDS['20%']) {
                    discountPercentage = DISCOUNT_PERCENTAGES['20%'];
                } else if (item.quantity >= DISCOUNT_THRESHOLDS['10%']) {
                    discountPercentage = DISCOUNT_PERCENTAGES['10%'];
                }

                if (discountPercentage > 0) {
                    const itemDiscount = itemSubtotal * discountPercentage;
                    itemTotal = itemSubtotal - itemDiscount;
                    itemsWithDiscount.push({
                        name: item.name,
                        discount: itemDiscount
                    });
                }

                subtotal += itemSubtotal;
                finalTotal += itemTotal;
            });

            totalDiscountAmount = subtotal - finalTotal;

            return {
                subtotal,
                finalTotal,
                totalDiscountAmount,
                itemsWithDiscount
            };
        }

        function addToCart(product, quantity = 1) {
            const existingItem = cart.find(item => item.name === product['Nombre del Producto']);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    name: product['Nombre del Producto'],
                    price: parseFloat(product.Precio),
                    quantity: quantity
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
            showNotification(`${quantity}x ${product['Nombre del Producto']} agregado al carrito.`);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.classList.add('notification');
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // --- Funciones del DOM y UI ---

        function displayProducts(productsToDisplay) {
            const productsContainer = document.getElementById('products');
            productsContainer.innerHTML = '';

            const categories = productsToDisplay.reduce((acc, product) => {
                const category = product.Categoría;
                if (category && category.trim() !== '') {
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(product);
                }
                return acc;
            }, {});

            Object.keys(categories).sort().forEach(categoryId => {
                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('category');
                categoryDiv.id = normalizeText(categoryId);

                categoryDiv.innerHTML = `<h2>${categoryId}</h2><div class="category-products"></div>`;

                const categoryProductsDiv = categoryDiv.querySelector('.category-products');
                categories[categoryId].forEach(productData => {
                    const isInStock = parseFloat(productData.Precio) > 0;
                    const productoDiv = document.createElement('div');
                    productoDiv.classList.add('producto');
                    productoDiv.dataset.nombre = productData['Nombre del Producto'];

                    const propertiesHtml = ['Sin TACC', 'Vegano', 'Sin Azucar', 'Sin Sal']
                        .filter(prop => productData[prop] === 'SI')
                        .map(prop => `<img src="${LOGO_URLS[normalizeText(prop)]}" alt="${prop}" class="logo-propiedad" title="${prop}">`)
                        .join('');

                    const productHtml = `
                        <img src="${productData['URL de la Imagen']}" alt="${productData['Nombre del Producto']}" onerror="this.src='${LOGO_URLS.placeholder}'; this.alt='Imagen no disponible';">
                        <div class="producto-info">
                            <h3>${productData['Nombre del Producto']}</h3>
                            <p class="${!isInStock ? 'no-stock' : ''}">Precio: ${!isInStock ? 'STOCK NO DISPONIBLE' : `$${parseFloat(productData.Precio).toFixed(2)}`}</p>
                            <div class="propiedades-container">${propertiesHtml}</div>
                            ${productData['Descripcion'] ? `
                            <div class="descripcion-container">
                                <span class="descripcion-corta">${productData['Descripcion'].split(' ').slice(0, 10).join(' ')}${productData['Descripcion'].split(' ').length > 10 ? '...' : ''}</span>
                                ${productData['Descripcion'].split(' ').length > 10 ? `<span class="descripcion-completa" style="display:none;">${productData['Descripcion']}</span><button class="leer-mas-btn">&#9660;</button>` : ''}
                            </div>
                            ` : ''}
                        </div>
                        <div class="producto-actions">
                            <input type="number" min="1" value="1" ${!isInStock ? 'disabled' : ''}>
                            <button class="add-to-cart-btn" data-product-name="${productData['Nombre del Producto']}" ${!isInStock ? 'disabled' : ''}>Agregar</button>
                        </div>
                    `;
                    productoDiv.innerHTML = productHtml;
                    categoryProductsDiv.appendChild(productoDiv);
                });
                productsContainer.appendChild(categoryDiv);
            });
        }

        function generateCategoryMenu(products) {
            const categoryMenu = document.querySelector('.menu-desplegable-contenido ul');
            const uniqueCategories = [...new Set(products.map(product => product.Categoría).filter(cat => cat && cat.trim() !== ''))];
            categoryMenu.innerHTML = '';

            uniqueCategories.sort().forEach(category => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = `#${normalizeText(category)}`;
                link.textContent = category.replace(/🌻|🫚|🫘|❄️|-/g, '').trim();
                listItem.appendChild(link);
                categoryMenu.appendChild(listItem);
            });
        }

        function setupSmoothScrolling() {
            document.querySelectorAll('.menu-desplegable-contenido ul li a').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                    document.querySelector('.menu-desplegable-contenido').style.display = 'none';
                });
            });
        }

        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
            const {
                subtotal,
                finalTotal,
                totalDiscountAmount
            } = calculateCartTotals();

            cart.forEach(item => {
                const li = document.createElement('li');
                li.classList.add('cart-item');
                const itemTotal = item.price * item.quantity;
                const discountPercentage = item.quantity >= DISCOUNT_THRESHOLDS['20%'] ? DISCOUNT_PERCENTAGES['20%'] :
                    item.quantity >= DISCOUNT_THRESHOLDS['10%'] ? DISCOUNT_PERCENTAGES['10%'] : 0;
                const itemFinalTotal = itemTotal - (itemTotal * discountPercentage);
                const discountMessage = discountPercentage > 0 ? ` (-${discountPercentage * 100}%)` : '';
                li.innerHTML = `
                    <div class="cart-item-details">
                        <p>${item.name}</p>
                        <p>Cant: ${item.quantity} | Total: $${itemFinalTotal.toFixed(2)}<span style="color: green;">${discountMessage}</span></p>
                    </div>
                    <div class="cart-item-quantity">
                        <button class="decrease-quantity" data-name="${item.name}">-</button>
                        <input type="number" value="${item.quantity}" min="1" data-name="${item.name}">
                        <button class="increase-quantity" data-name="${item.name}">+</button>
                    </div>
                    <button class="remove-item" data-name="${item.name}">&times;</button>
                `;
                cartItemsContainer.appendChild(li);
            });

            document.getElementById('cart-subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('cart-discount-message').textContent = totalDiscountAmount > 0 ? `Descuento total: -$${totalDiscountAmount.toFixed(2)}` : '';
            document.getElementById('cart-total').textContent = finalTotal.toFixed(2);
            document.getElementById('cart-count').textContent = cart.length;
            document.getElementById('cart-count').style.display = cart.length > 0 ? 'flex' : 'none';
            document.getElementById('send-order-button').disabled = cart.length === 0;
        }

        // --- Lógica del Escáner QR ---
        const qrScannerContainer = document.getElementById('qr-scanner-container');
        const readerDiv = document.getElementById('reader');
        let html5QrcodeScanner = null;

        function startQrScanner() {
            if (qrScannerContainer.style.display === 'flex') {
                return;
            }
            qrScannerContainer.style.display = 'flex';

            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader", {
                        fps: 10,
                        qrbox: {
                            width: 250,
                            height: 250
                        },
                        supportedScanFormats: [Html5QrcodeSupportedFormats.QR_CODE]
                    },
                    false
                );
            }
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function stopQrScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    console.log("✅ Escáner QR detenido.");
                    qrScannerContainer.style.display = 'none';
                }).catch(error => {
                    console.warn("🟡 Advertencia: El escáner ya estaba detenido.", error);
                    qrScannerContainer.style.display = 'none';
                });
            } else {
                qrScannerContainer.style.display = 'none';
            }
        }

        function onScanSuccess(decodedText) {
            console.log(`🟢 Código escaneado con éxito: ${decodedText}`);

            const normalizedText = normalizeText(decodedText);
            const product = allProducts.find(p => normalizeText(p['Nombre del Producto']) === normalizedText);

            if (product) {
                addToCart(product, 1);
                showNotification(`Producto escaneado y agregado: ${product['Nombre del Producto']}`);
                stopQrScanner();
            } else {
                showNotification(`Producto "${decodedText}" no encontrado.`);
            }
        }

        function onScanFailure(errorMessage) {
            if (!errorMessage.includes("No QR code found")) {
                console.warn(`🔴 Error de escaneo: ${errorMessage}`);
            }
        }

        // --- Lógica de Eventos y Manejadores ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(productsUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvData = await response.text();
                allProducts = parseCSV(csvData);

                displayProducts(allProducts);
                generateCategoryMenu(allProducts);
                setupSmoothScrolling();
                updateCartDisplay();
                console.log('✅ Carga de productos completada.');
            } catch (error) {
                console.error('🔴 Error al cargar los productos:', error);
                document.getElementById('products').innerHTML = '<p class="error">Error al cargar los productos. Por favor, intenta nuevamente más tarde.</p>';
            }
        });

        document.body.addEventListener('click', (event) => {
            const target = event.target;

            if (target.classList.contains('add-to-cart-btn')) {
                const productDiv = target.closest('.producto');
                const productName = productDiv.dataset.nombre;
                const quantityInput = productDiv.querySelector('input[type="number"]');
                const quantity = parseInt(quantityInput.value);

                if (quantity > 0) {
                    const productToAdd = allProducts.find(p => p['Nombre del Producto'] === productName);
                    if (productToAdd) {
                        addToCart(productToAdd, quantity);
                    }
                }
            }

            if (target.classList.contains('increase-quantity') || target.classList.contains('decrease-quantity')) {
                const productName = target.dataset.name;
                const item = cart.find(i => i.name === productName);
                if (!item) return;

                if (target.classList.contains('increase-quantity')) {
                    item.quantity++;
                } else if (target.classList.contains('decrease-quantity') && item.quantity > 1) {
                    item.quantity--;
                }
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
            }

            if (target.classList.contains('remove-item')) {
                const productName = target.dataset.name;
                cart = cart.filter(i => i.name !== productName);
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
            }

            if (target.classList.contains('leer-mas-btn')) {
                const container = target.closest('.descripcion-container');
                const shortSpan = container.querySelector('.descripcion-corta');
                const fullSpan = container.querySelector('.descripcion-completa');
                const isCollapsed = shortSpan.style.display !== 'none';
                shortSpan.style.display = isCollapsed ? 'none' : 'inline';
                fullSpan.style.display = isCollapsed ? 'inline' : 'none';
                target.innerHTML = isCollapsed ? '&#9650;' : '&#9660;';
            }
        });

        document.getElementById('search').addEventListener('input', (event) => {
            const searchTerm = normalizeText(event.target.value);
            const filteredProducts = allProducts.filter(product => {
                const searchString = `${normalizeText(product['Nombre del Producto'])} ${normalizeText(product.Categoría)} ${normalizeText(product.Descripcion || '')}`;
                return searchString.includes(searchTerm);
            });
            displayProducts(filteredProducts);
        });

        document.getElementById('send-order-button').addEventListener('click', () => {
            if (cart.length === 0) {
                alert('El carrito está vacío.');
                return;
            }

            let message = 'Hola, me gustaría hacer un pedido:\n\n';
            const {
                finalTotal
            } = calculateCartTotals();

            cart.forEach(item => {
                const itemTotal = item.quantity >= DISCOUNT_THRESHOLDS['20%'] ? (item.price * item.quantity) * (1 - DISCOUNT_PERCENTAGES['20%']) :
                    item.quantity >= DISCOUNT_THRESHOLDS['10%'] ? (item.price * item.quantity) * (1 - DISCOUNT_PERCENTAGES['10%']) :
                    item.price * item.quantity;
                message += `* ${item.name} - Cantidad: ${item.quantity} - Subtotal: $${itemTotal.toFixed(2)}\n`;
            });

            message += `\n*TOTAL: $${finalTotal.toFixed(2)}*\n\n`;
            message += '¡Gracias!';

            const whatsappUrl = `https://wa.me/+5491164708681?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });

        // Manejadores de los iconos principales para mostrar/ocultar paneles
        document.getElementById('cart-icon').addEventListener('click', () => {
            document.getElementById('cart').style.display = document.getElementById('cart').style.display === 'block' ? 'none' : 'block';
            document.getElementById('search').style.display = 'none';
            document.querySelector('.menu-desplegable-contenido').style.display = 'none';
            stopQrScanner();
        });

        document.getElementById('search-icon').addEventListener('click', () => {
            document.getElementById('search').style.display = document.getElementById('search').style.display === 'block' ? 'none' : 'block';
            document.getElementById('cart').style.display = 'none';
            document.querySelector('.menu-desplegable-contenido').style.display = 'none';
            stopQrScanner();
        });

        document.getElementById('category-icon').addEventListener('click', () => {
            document.querySelector('.menu-desplegable-contenido').style.display = document.querySelector('.menu-desplegable-contenido').style.display === 'block' ? 'none' : 'block';
            document.getElementById('cart').style.display = 'none';
            document.getElementById('search').style.display = 'none';
            stopQrScanner();
        });

        document.getElementById('qr-scan-icon').addEventListener('click', () => {
            startQrScanner();
            document.getElementById('cart').style.display = 'none';
            document.getElementById('search').style.display = 'none';
            document.querySelector('.menu-desplegable-contenido').style.display = 'none';
        });

        document.getElementById('close-qr-scanner').addEventListener('click', () => {
            stopQrScanner();
        });

        // Botones para volver al inicio
        document.getElementById('scroll-top-icon').addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        document.getElementById('scroll-to-top-footer').addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>

</html>
